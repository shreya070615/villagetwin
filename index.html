<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AgriVerse â€“ Realistic Digital Twin Village</title>
<style>
  body { margin: 0; overflow: hidden; }
  #infoBox {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 280px;
    padding: 12px;
    background: rgba(0,0,0,0.75);
    color: white;
    display: none;
    border-radius: 8px;
    font-family: Arial;
  }
</style>
</head>
<body>
<div id="infoBox"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<script>
// ---------- SCENE ----------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

// ---------- CAMERA ----------
const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(40, 30, 45);

// ---------- RENDERER ----------
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ---------- CONTROLS ----------
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.target.set(0,0,0);

// ---------- LIGHTS ----------
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const sun = new THREE.DirectionalLight(0xffffff, 1);
sun.position.set(50, 60, 30);
scene.add(sun);

// ---------- GROUND ----------
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(150, 150),
  new THREE.MeshStandardMaterial({color:0x3f9d23})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ---------- CLICKABLE SYSTEM ----------
const clickable = [];
const infoBox = document.getElementById("infoBox");
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function makeClickable(mesh, html){
  mesh.userData.info = html;
  clickable.push(mesh);
}

// ---------- GLTF LOADER ----------
const loader = new THREE.GLTFLoader();

// ---------- HOUSES ----------
const housePositions = [
  [-12,-30],[-12,-10],[-12,10],[-12,30],
  [12,-30],[12,-10],[12,10],[12,30]
];
housePositions.forEach(pos => {
  loader.load('models/farm_house.glb', gltf=>{
    const house = gltf.scene;
    house.position.set(pos[0],0,pos[1]);
    house.scale.set(1,1,1);
    scene.add(house);
    makeClickable(house, "<h3>ğŸ  Farm House</h3>Family Info");
  }, undefined, err=>console.error(err));
});

// ---------- BARN ----------
loader.load('models/barn.glb', gltf=>{
  const barn = gltf.scene;
  barn.position.set(-25,0,20);
  barn.scale.set(1,1,1);
  scene.add(barn);
  makeClickable(barn, "<h3>ğŸšï¸ Barn</h3>Storage: Hay & Tools");
});

// ---------- FARMER ----------
let farmer, farmerMixer;
loader.load('models/farmer.glb', gltf=>{
  farmer = gltf.scene;
  farmer.position.set(5,0,5);
  farmer.scale.set(1,1,1);
  scene.add(farmer);
  makeClickable(farmer, "<h3>ğŸ‘¨â€ğŸŒ¾ Farmer</h3>Name: Ramesh");

  if(gltf.animations.length>0){
    farmerMixer = new THREE.AnimationMixer(farmer);
    const action = farmerMixer.clipAction(gltf.animations[0]);
    action.play();
  }
});

// ---------- COWS ----------
const cows = [];
const cowPositions = [[5,-18],[9,-20]];
cowPositions.forEach(pos=>{
  loader.load('models/cow.glb', gltf=>{
    const cow = gltf.scene;
    cow.position.set(pos[0],0,pos[1]);
    cow.scale.set(1,1,1);
    scene.add(cow);
    cows.push(cow);
    makeClickable(cow, "<h3>ğŸ„ Cow</h3>Healthy");
  });
});

// ---------- TREES ----------
const treePositions = [[-25,-35],[-25,35],[0,-45],[0,45]];
treePositions.forEach(pos=>{
  loader.load('models/tree1.glb', gltf=>{
    const tree = gltf.scene;
    tree.position.set(pos[0],0,pos[1]);
    tree.scale.set(1,1,1);
    scene.add(tree);
  });
});

// ---------- TRACTOR ----------
loader.load('models/tractor.glb', gltf=>{
  const tractor = gltf.scene;
  tractor.position.set(30,0,-20);
  tractor.scale.set(1,1,1);
  scene.add(tractor);
  makeClickable(tractor, "<h3>ğŸšœ Tractor</h3>Status: Ready");
});

// ---------- CLICK HANDLER ----------
window.addEventListener('pointerdown', e=>{
  mouse.x = (e.clientX / window.innerWidth) * 2 -1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 +1;
  raycaster.setFromCamera(mouse,camera);
  const hits = raycaster.intersectObjects(clickable,true);
  if(hits.length>0){
    infoBox.innerHTML = hits[0].object.userData.info;
    infoBox.style.display = "block";
  }
});

// ---------- ANIMATION ----------
let farmerDir = 1;
let cowAngle = 0;

function animate(){
  requestAnimationFrame(animate);

  // Farmer walking
  if(farmer){
    farmer.position.x += 0.03 * farmerDir;
    if(farmer.position.x>10 || farmer.position.x<-2) farmerDir*=-1;
    if(farmerMixer) farmerMixer.update(0.01);
  }

  // Cows moving slightly
  cowAngle += 0.01;
  cows.forEach((cow,i)=>{
    cow.position.x += Math.sin(cowAngle+i)*0.01;
    cow.position.z += Math.cos(cowAngle+i)*0.01;
  });

  controls.update();
  renderer.render(scene,camera);
}
animate();

// ---------- RESIZE ----------
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
